name: Build sdat2img Go (Universal)

on: workflow_dispatch

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build All Platforms
        run: |
          echo "ğŸ”¨ Building for Windows (x64)..."
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o sdat2img.exe sdat2img.go
          
          echo "ğŸ”¨ Building for Linux (x64)..."
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o sdat2img_linux sdat2img.go
          
          echo "ğŸ”¨ Building for Android (ARM64)..."
          GOOS=android GOARCH=arm64 go build -ldflags="-s -w" -o sdat2img_android sdat2img.go

          echo "ğŸ”¨ Building for macOS (Intel)..."
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o sdat2img_mac_amd64 sdat2img.go
          
          echo "ğŸ”¨ Building for macOS (Apple Silicon)..."
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o sdat2img_mac_arm64 sdat2img.go

      - name: Merge macOS Universal Binary
        run: |
          echo "ğŸ”€ Merging macOS binaries with lipo..."
          # åˆå¹¶ Intel å’Œ M1 ç‰ˆæœ¬
          lipo -create sdat2img_mac_amd64 sdat2img_mac_arm64 -output sdat2img_mac
          
          # èµ‹äºˆæ‰§è¡Œæƒé™
          chmod +x sdat2img_mac
          
          # éªŒè¯æ–‡ä»¶ç±»å‹ (æ—¥å¿—é‡Œä¼šæ˜¾ç¤º Universal binary)
          file sdat2img_mac
          
          # æ¸…ç†æ‰ä¸å†éœ€è¦çš„å•æ¶æ„æ–‡ä»¶
          rm sdat2img_mac_amd64 sdat2img_mac_arm64

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sdat2img-binaries
          path: |
            sdat2img.exe
            sdat2img_linux
            sdat2img_android
            sdat2img_mac
